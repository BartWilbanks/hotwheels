<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no" />
  <title>Racer Controller</title>
  <style>
    body { margin:0; font-family: system-ui, Arial; background:#0b1220; color:#fff; }
    header { padding:12px; background:#0a2342; position:sticky; top:0; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1b2b4a; }
    .wrap { padding:12px; max-width:520px; margin:0 auto; }
    input, button { width:100%; padding:12px; border-radius:14px; border:0; font-size:16px; }
    input { margin:6px 0 10px; }
    button { background:#6bbf59; color:#0a2342; font-weight:900; }
    button.secondary { background:#1b2b4a; color:#fff; font-weight:800; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
    .pad { display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
    .btn {
      height:92px; display:flex; align-items:center; justify-content:center;
      border-radius:18px; font-weight:900; font-size:18px;
      background:#132445; user-select:none; -webkit-user-select:none;
      touch-action:none;
    }
    .btn.on { background:#6bbf59; color:#0a2342; }
    small { opacity:.85; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:900">Controller</div>
      <div class="pill mono" id="roomPill">ROOM: ----</div>
    </div>
  </header>

  <div class="wrap">
    <div id="joinBox">
      <label><b>Room Code</b></label>
      <input id="room" placeholder="ABCD" autocapitalize="characters" autocomplete="off" />
      <label><b>Your Name</b></label>
      <input id="name" placeholder="Bart" maxlength="16" autocomplete="off" />
      <button id="join">Join Game</button>
      <div style="margin-top:10px;"><small id="status"></small></div>
    </div>

    <div id="controls" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div><b>Connected</b> <span class="pill" id="modePill">BUILD MODE</span></div>
        <button class="secondary" id="disconnect" style="width:auto; padding:10px 12px;">Disconnect</button>
      </div>

      <div class="pad">
        <div class="btn" id="left">⬅️ LEFT</div>
        <div class="btn" id="right">RIGHT ➡️</div>
        <div class="btn" id="up">⬆️ GAS</div>
        <div class="btn" id="down">⬇️ BRAKE</div>
      </div>

      <div style="margin-top:14px;">
        <small>Tip: keep your thumb on GAS and tap LEFT/RIGHT to steer.</small>
      </div>

      <div style="margin-top:14px;">
        <b>Players</b>
        <div id="players" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const roomInput = document.getElementById('room');
  const nameInput = document.getElementById('name');
  const joinBtn = document.getElementById('join');
  const statusEl = document.getElementById('status');
  const joinBox = document.getElementById('joinBox');
  const controls = document.getElementById('controls');
  const roomPill = document.getElementById('roomPill');
  const modePill = document.getElementById('modePill');
  const playersEl = document.getElementById('players');
  const disconnectBtn = document.getElementById('disconnect');

  const btnLeft = document.getElementById('left');
  const btnRight = document.getElementById('right');
  const btnUp = document.getElementById('up');
  const btnDown = document.getElementById('down');

  let ws = null;
  let playerId = null;
  let roomCode = null;
  let inputs = { up:false, down:false, left:false, right:false };

  function wsUrl(){
    const proto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
    return `${proto}//${location.host}/ws`;
  }

  function setStatus(s){ statusEl.textContent = s; }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function parseQuery(){
    const u = new URL(location.href);
    const r = u.searchParams.get('room');
    if (r) roomInput.value = r.toUpperCase().trim();
  }

  function connect(){
    return new Promise((resolve, reject) => {
      ws = new WebSocket(wsUrl());
      ws.onopen = () => resolve();
      ws.onerror = (e) => reject(e);
      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        handle(msg);
      };
      ws.onclose = () => {
        setStatus('Disconnected.');
        // show join again
        joinBox.style.display = '';
        controls.style.display = 'none';
      };
    });
  }

  function send(obj){
    if (!ws || ws.readyState !== 1) return;
    ws.send(JSON.stringify(obj));
  }

  function join(){
    roomCode = roomInput.value.toUpperCase().trim();
    const name = nameInput.value.trim() || 'Player';
    if (!roomCode || roomCode.length < 3){
      setStatus('Enter a valid room code.');
      return;
    }
    roomPill.textContent = `ROOM: ${roomCode}`;
    send({ t:'join', room: roomCode, name });
    setStatus('Joining...');
  }

  function handle(msg){
    if (!msg || !msg.t) return;

    if (msg.t === 'joined'){
      playerId = msg.playerId;
      joinBox.style.display = 'none';
      controls.style.display = '';
      setStatus('');
      // send initial inputs (all false)
      send({ t:'input', room: roomCode, playerId, inputs });
      return;
    }

    if (msg.t === 'error'){
      setStatus(msg.message || 'Error.');
      return;
    }

    if (msg.t === 'mode'){
      modePill.textContent = msg.driveMode ? 'DRIVE MODE' : 'BUILD MODE';
      modePill.style.background = msg.driveMode ? '#6bbf59' : '#1b2b4a';
      modePill.style.color = msg.driveMode ? '#0a2342' : '#fff';
      return;
    }

    if (msg.t === 'state' && Array.isArray(msg.players)){
      playersEl.innerHTML = msg.players.map(p =>
        `<div style="opacity:.92">• <b>${escapeHtml(p.name)}</b></div>`
      ).join('');
      return;
    }
  }

  function bindHold(btn, key){
    const set = (on) => {
      inputs[key] = on;
      btn.classList.toggle('on', on);
      if (playerId && roomCode) send({ t:'input', room: roomCode, playerId, inputs });
    };

    const down = (e) => { e.preventDefault(); set(true); };
    const up = (e) => { e.preventDefault(); set(false); };

    btn.addEventListener('pointerdown', down);
    btn.addEventListener('pointerup', up);
    btn.addEventListener('pointercancel', up);
    btn.addEventListener('pointerleave', up);
  }

  disconnectBtn.onclick = () => {
    try { ws.close(); } catch {}
  };

  joinBtn.onclick = async () => {
    try{
      setStatus('Connecting...');
      await connect();
      join();
    }catch{
      setStatus('Could not connect. If you are on HTTPS, you need WSS (Render provides).');
    }
  };

  // also allow enter to join
  [roomInput, nameInput].forEach(inp => inp.addEventListener('keydown', (e)=> {
    if (e.key === 'Enter') joinBtn.click();
  }));

  bindHold(btnLeft, 'left');
  bindHold(btnRight, 'right');
  bindHold(btnUp, 'up');
  bindHold(btnDown, 'down');

  parseQuery();
})();
</script>
</body>
</html>
